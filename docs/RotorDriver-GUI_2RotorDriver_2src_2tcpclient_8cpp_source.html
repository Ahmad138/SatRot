<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>SatRot - Taking Everyone to Space: RotorDriver-GUI/RotorDriver/src/tcpclient.cpp Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="SatRot logo_small_small.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">SatRot - Taking Everyone to Space
   &#160;<span id="projectnumber">v1.0</span>
   </div>
   <div id="projectbrief">SatRot is a very cheap, modular and smart satellite rotator. It has the ability to automatically and manually control a load device such as an antenna for satellite communications, solar panel to track sun, telescope to observe patch of the night sky and others. The construction materials are so cheap and easy to build that high school students can DIY build the system.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">tcpclient.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="preprocessor">#include &quot;includes/tcpclient.h&quot;</span></div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="preprocessor">#include &lt;QTcpSocket&gt;</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="preprocessor">#include &lt;QDataStream&gt;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;<span class="preprocessor">#include &lt;QJsonParseError&gt;</span></div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;<span class="preprocessor">#include &lt;QJsonDocument&gt;</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;<span class="preprocessor">#include &lt;QJsonObject&gt;</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;<span class="preprocessor">#include &lt;QJsonValue&gt;</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;</div><div class="line"><a name="l00010"></a><span class="lineno"><a class="line" href="classTCPClient.html#a2c268dae3253635894728162ddef557a">   10</a></span>&#160;<a class="code" href="classTCPClient.html#a2c268dae3253635894728162ddef557a">TCPClient::TCPClient</a>(QObject *parent)</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;    : QObject(parent)</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;    , m_clientSocket(new QTcpSocket(this))</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;    , m_loggedIn(false)</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;{</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;    <span class="comment">// Forward the connected and disconnected signals</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;    connect(m_clientSocket, &amp;QTcpSocket::connected, <span class="keyword">this</span>, &amp;<a class="code" href="classTCPClient.html#af9cb581e63f94abbb8c0117c17f252bd">TCPClient::connected</a>);</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;    connect(m_clientSocket, &amp;QTcpSocket::disconnected, <span class="keyword">this</span>, &amp;<a class="code" href="classTCPClient.html#a6d7c40735979ee6a5788ad5813b93d14">TCPClient::disconnected</a>);</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;    <span class="comment">// connect readyRead() to the slot that will take care of reading the data in</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;    connect(m_clientSocket, &amp;QTcpSocket::readyRead, <span class="keyword">this</span>, &amp;TCPClient::onReadyRead);</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;    <span class="comment">// Forward the error signal, QOverload is necessary as error() is overloaded, see the Qt docs</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;    connect(m_clientSocket, QOverload&lt;QAbstractSocket::SocketError&gt;::of(&amp;QAbstractSocket::error), <span class="keyword">this</span>, &amp;<a class="code" href="classTCPClient.html#a8d2ac91529f9dd88818b7b1ca265d975">TCPClient::error</a>);</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;    <span class="comment">// Reset the m_loggedIn variable when we disconnec. Since the operation is trivial we use a lambda instead of creating another slot</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;    connect(m_clientSocket, &amp;QTcpSocket::disconnected, <span class="keyword">this</span>, [<span class="keyword">this</span>]()-&gt;<span class="keywordtype">void</span>{m_loggedIn = <span class="keyword">false</span>;});</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;}</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno"><a class="line" href="classTCPClient.html#a1223f17c35683c78186f66b24296cea4">   26</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classTCPClient.html#a1223f17c35683c78186f66b24296cea4">TCPClient::login</a>(<span class="keyword">const</span> QString &amp;userName)</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;{</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;    <span class="keywordflow">if</span> (m_clientSocket-&gt;state() == QAbstractSocket::ConnectedState) { <span class="comment">// if the client is connected</span></div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;        <span class="comment">// create a QDataStream operating on the socket</span></div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;        QDataStream clientStream(m_clientSocket);</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;        <span class="comment">// set the version so that programs compiled with different versions of Qt can agree on how to serialise</span></div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;        clientStream.setVersion(QDataStream::Qt_5_7);</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;        <span class="comment">// Create the JSON we want to send</span></div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;        QJsonObject message;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;        message[<span class="stringliteral">&quot;type&quot;</span>] = QStringLiteral(<span class="stringliteral">&quot;login&quot;</span>);</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;        message[<span class="stringliteral">&quot;username&quot;</span>] = userName;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;        <span class="comment">// send the JSON using QDataStream</span></div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;        clientStream &lt;&lt; QJsonDocument(message).toJson(QJsonDocument::Compact);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;    }</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;}</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno"><a class="line" href="classTCPClient.html#aa9b17560c0541f8e6d6a827d93802e3f">   42</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classTCPClient.html#aa9b17560c0541f8e6d6a827d93802e3f">TCPClient::sendMessage</a>(<span class="keyword">const</span> QString &amp;text)</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;{</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;    <span class="keywordflow">if</span> (text.isEmpty())</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;        <span class="keywordflow">return</span>; <span class="comment">// We don&#39;t send empty messages</span></div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;    <span class="comment">// create a QDataStream operating on the socket</span></div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;    QDataStream clientStream(m_clientSocket);</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;    <span class="comment">// set the version so that programs compiled with different versions of Qt can agree on how to serialise</span></div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;    clientStream.setVersion(QDataStream::Qt_5_7);</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;    <span class="comment">// Create the JSON we want to send</span></div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;    QJsonObject message;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;    message[<span class="stringliteral">&quot;type&quot;</span>] = QStringLiteral(<span class="stringliteral">&quot;message&quot;</span>);</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    message[<span class="stringliteral">&quot;text&quot;</span>] = text;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;    <span class="comment">// send the JSON using QDataStream</span></div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;    clientStream &lt;&lt; QJsonDocument(message).toJson();</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;}</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno"><a class="line" href="classTCPClient.html#af039e584125912715c7eb7b095e168d7">   58</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classTCPClient.html#af039e584125912715c7eb7b095e168d7">TCPClient::sendTrackingDetails</a>(QJsonObject &amp;text, QString satDataType, <span class="keywordtype">bool</span> mode)</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;{</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;    <span class="keywordflow">if</span> (text.isEmpty())</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;        <span class="keywordflow">return</span>; <span class="comment">// We don&#39;t send empty messages</span></div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;    <span class="comment">// create a QDataStream operating on the socket</span></div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;    QDataStream clientStream(m_clientSocket);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;    <span class="comment">// set the version so that programs compiled with different versions of Qt can agree on how to serialise</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;    clientStream.setVersion(QDataStream::Qt_5_7);</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;    <span class="comment">// Create the JSON we want to send</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;    text.insert(<span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;message&quot;</span>);</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;    text.insert(<span class="stringliteral">&quot;satDataType&quot;</span>, satDataType);</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">if</span>(mode){</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;        text.insert(<span class="stringliteral">&quot;mode&quot;</span>, <span class="stringliteral">&quot;Automatic&quot;</span>);</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;    }<span class="keywordflow">else</span>{</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;        text.insert(<span class="stringliteral">&quot;mode&quot;</span>, <span class="stringliteral">&quot;Manual&quot;</span>);</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;    }</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;<span class="comment">//    QJsonObject message;</span></div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;<span class="comment">//    message[&quot;type&quot;] = QStringLiteral(&quot;message&quot;);</span></div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;<span class="comment">//    message[&quot;text&quot;] = text;</span></div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;    <span class="comment">// send the JSON using QDataStream</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;    clientStream &lt;&lt; QJsonDocument(text).toJson();</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;}</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno"><a class="line" href="classTCPClient.html#a90450d308618c7ead92e946d173d1bc2">   84</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classTCPClient.html#a90450d308618c7ead92e946d173d1bc2">TCPClient::disconnectFromHost</a>()</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;{</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;    m_clientSocket-&gt;disconnectFromHost();</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;}</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;<span class="keywordtype">void</span> TCPClient::jsonReceived(<span class="keyword">const</span> QJsonObject &amp;docObj)</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;{</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;    <span class="comment">// actions depend on the type of message</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;    <span class="keyword">const</span> QJsonValue typeVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;type&quot;</span>));</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;    <span class="keywordflow">if</span> (typeVal.isNull() || !typeVal.isString())</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;        <span class="keywordflow">return</span>; <span class="comment">// a message with no type was received so we just ignore it</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;    <span class="keywordflow">if</span> (typeVal.toString().compare(QLatin1String(<span class="stringliteral">&quot;login&quot;</span>), Qt::CaseInsensitive) == 0) { <span class="comment">//It&#39;s a login message</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;        <span class="keywordflow">if</span> (m_loggedIn)</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// if we are already logged in we ignore</span></div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;        <span class="comment">// the success field will contain the result of our attempt to login</span></div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;        <span class="keyword">const</span> QJsonValue resultVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;success&quot;</span>));</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        <span class="keywordflow">if</span> (resultVal.isNull() || !resultVal.isBool())</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// the message had no success field so we ignore</span></div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> loginSuccess = resultVal.toBool();</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        <span class="keywordflow">if</span> (loginSuccess) {</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;            <span class="comment">// we logged in succesfully and we notify it via the loggedIn signal</span></div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;            emit <a class="code" href="classTCPClient.html#a0e780d07d33d9e86c1b9804428355d06">loggedIn</a>();</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;            <span class="keywordflow">return</span>;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;        }</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="comment">// the login attempt failed, we extract the reason of the failure from the JSON</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;        <span class="comment">// and notify it via the loginError signal</span></div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;        <span class="keyword">const</span> QJsonValue reasonVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;reason&quot;</span>));</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        emit <a class="code" href="classTCPClient.html#a3dcd6cc23bc5c229ec648b35012c9533">loginError</a>(reasonVal.toString());</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (typeVal.toString().compare(QLatin1String(<span class="stringliteral">&quot;message&quot;</span>), Qt::CaseInsensitive) == 0) { <span class="comment">//It&#39;s a message</span></div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;        <span class="comment">// we extract the text field containing the text</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;        <span class="keyword">const</span> QJsonValue textVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;text&quot;</span>));</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;        <span class="comment">// we extract the sender field containing the username of the sender</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        <span class="keyword">const</span> QJsonValue senderVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;sender&quot;</span>));</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">if</span> (textVal.isNull() || !textVal.isString())</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// the text field was invalid so we ignore</span></div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;        <span class="keywordflow">if</span> (senderVal.isNull() || !senderVal.isString())</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// the sender field was invalid so we ignore</span></div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;        <span class="comment">// we notify a new message was received via the messageReceived signal</span></div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;        emit <a class="code" href="classTCPClient.html#ad2c0c634eb37a08c65e5545642af2a0e">messageReceived</a>(senderVal.toString(), textVal.toString());</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (typeVal.toString().compare(QLatin1String(<span class="stringliteral">&quot;newuser&quot;</span>), Qt::CaseInsensitive) == 0) { <span class="comment">// A user joined the network</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;        <span class="comment">// we extract the username of the new user</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;        <span class="keyword">const</span> QJsonValue usernameVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;username&quot;</span>));</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        <span class="keywordflow">if</span> (usernameVal.isNull() || !usernameVal.isString())</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// the username was invalid so we ignore</span></div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;        <span class="comment">// we notify of the new user via the userJoined signal</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;        emit <a class="code" href="classTCPClient.html#a1db453ba6cc7cae3e1ce198aa137baf1">userJoined</a>(usernameVal.toString());</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (typeVal.toString().compare(QLatin1String(<span class="stringliteral">&quot;userdisconnected&quot;</span>), Qt::CaseInsensitive) == 0) { <span class="comment">// A user left the network</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;        <span class="comment">// we extract the username of the new user</span></div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;        <span class="keyword">const</span> QJsonValue usernameVal = docObj.value(QLatin1String(<span class="stringliteral">&quot;username&quot;</span>));</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;        <span class="keywordflow">if</span> (usernameVal.isNull() || !usernameVal.isString())</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="keywordflow">return</span>; <span class="comment">// the username was invalid so we ignore</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;        <span class="comment">// we notify of the user disconnection the userLeft signal</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;        emit <a class="code" href="classTCPClient.html#ac23819654a04521dda35667345b31ab0">userLeft</a>(usernameVal.toString());</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;    }</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;}</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno"><a class="line" href="classTCPClient.html#aa7b2c1d927b954f0e6e0feb13c447a61">  140</a></span>&#160;<span class="keywordtype">void</span> <a class="code" href="classTCPClient.html#aa7b2c1d927b954f0e6e0feb13c447a61">TCPClient::connectToServer</a>(<span class="keyword">const</span> QHostAddress &amp;address, quint16 port)</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;{</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;    m_clientSocket-&gt;connectToHost(address, port);</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;}</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;<span class="keywordtype">void</span> TCPClient::onReadyRead()</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;{</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;    <span class="comment">// prepare a container to hold the UTF-8 encoded JSON we receive from the socket</span></div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;    QByteArray jsonData;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;    <span class="comment">// create a QDataStream operating on the socket</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    QDataStream socketStream(m_clientSocket);</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="comment">// set the version so that programs compiled with different versions of Qt can agree on how to serialise</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    socketStream.setVersion(QDataStream::Qt_5_7);</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;    <span class="comment">// start an infinite loop</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;    <span class="keywordflow">for</span> (;;) {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="comment">// we start a transaction so we can revert to the previous state in case we try to read more data than is available on the socket</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        socketStream.startTransaction();</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        <span class="comment">// we try to read the JSON data</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;        socketStream &gt;&gt; jsonData;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;        <span class="keywordflow">if</span> (socketStream.commitTransaction()) {</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;            <span class="comment">// we successfully read some data</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;            <span class="comment">// we now need to make sure it&#39;s in fact a valid JSON</span></div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;            QJsonParseError parseError;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;            <span class="comment">// we try to create a json document with the data we received</span></div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;            <span class="keyword">const</span> QJsonDocument jsonDoc = QJsonDocument::fromJson(jsonData, &amp;parseError);</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;            <span class="keywordflow">if</span> (parseError.error == QJsonParseError::NoError) {</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;                <span class="comment">// if the data was indeed valid JSON</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;                <span class="keywordflow">if</span> (jsonDoc.isObject()) <span class="comment">// and is a JSON object</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;                    jsonReceived(jsonDoc.object()); <span class="comment">// parse the JSON</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;            }</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;            <span class="comment">// loop and try to read more JSONs if they are available</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;        } <span class="keywordflow">else</span> {</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;            <span class="comment">// the read failed, the socket goes automatically back to the state it was in before the transaction started</span></div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;            <span class="comment">// we just exit the loop and wait for more data to become available</span></div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;            <span class="keywordflow">break</span>;</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;        }</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    }</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;}</div><div class="ttc" id="classTCPClient_html_a90450d308618c7ead92e946d173d1bc2"><div class="ttname"><a href="classTCPClient.html#a90450d308618c7ead92e946d173d1bc2">TCPClient::disconnectFromHost</a></div><div class="ttdeci">void disconnectFromHost()</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00084">tcpclient.cpp:84</a></div></div>
<div class="ttc" id="classTCPClient_html_a6d7c40735979ee6a5788ad5813b93d14"><div class="ttname"><a href="classTCPClient.html#a6d7c40735979ee6a5788ad5813b93d14">TCPClient::disconnected</a></div><div class="ttdeci">void disconnected()</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00286">moc_tcpclient.cpp:286</a></div></div>
<div class="ttc" id="classTCPClient_html_a2c268dae3253635894728162ddef557a"><div class="ttname"><a href="classTCPClient.html#a2c268dae3253635894728162ddef557a">TCPClient::TCPClient</a></div><div class="ttdeci">TCPClient(QObject *parent=nullptr)</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00010">tcpclient.cpp:10</a></div></div>
<div class="ttc" id="classTCPClient_html_a1223f17c35683c78186f66b24296cea4"><div class="ttname"><a href="classTCPClient.html#a1223f17c35683c78186f66b24296cea4">TCPClient::login</a></div><div class="ttdeci">void login(const QString &amp;userName)</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00026">tcpclient.cpp:26</a></div></div>
<div class="ttc" id="classTCPClient_html_aa7b2c1d927b954f0e6e0feb13c447a61"><div class="ttname"><a href="classTCPClient.html#aa7b2c1d927b954f0e6e0feb13c447a61">TCPClient::connectToServer</a></div><div class="ttdeci">void connectToServer(const QHostAddress &amp;address, quint16 port)</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00140">tcpclient.cpp:140</a></div></div>
<div class="ttc" id="classTCPClient_html_af9cb581e63f94abbb8c0117c17f252bd"><div class="ttname"><a href="classTCPClient.html#af9cb581e63f94abbb8c0117c17f252bd">TCPClient::connected</a></div><div class="ttdeci">void connected()</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00267">moc_tcpclient.cpp:267</a></div></div>
<div class="ttc" id="classTCPClient_html_a0e780d07d33d9e86c1b9804428355d06"><div class="ttname"><a href="classTCPClient.html#a0e780d07d33d9e86c1b9804428355d06">TCPClient::loggedIn</a></div><div class="ttdeci">void loggedIn()</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00273">moc_tcpclient.cpp:273</a></div></div>
<div class="ttc" id="classTCPClient_html_a1db453ba6cc7cae3e1ce198aa137baf1"><div class="ttname"><a href="classTCPClient.html#a1db453ba6cc7cae3e1ce198aa137baf1">TCPClient::userJoined</a></div><div class="ttdeci">void userJoined(const QString &amp;username)</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00306">moc_tcpclient.cpp:306</a></div></div>
<div class="ttc" id="classTCPClient_html_ad2c0c634eb37a08c65e5545642af2a0e"><div class="ttname"><a href="classTCPClient.html#ad2c0c634eb37a08c65e5545642af2a0e">TCPClient::messageReceived</a></div><div class="ttdeci">void messageReceived(const QString &amp;sender, const QString &amp;text)</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00292">moc_tcpclient.cpp:292</a></div></div>
<div class="ttc" id="classTCPClient_html_a3dcd6cc23bc5c229ec648b35012c9533"><div class="ttname"><a href="classTCPClient.html#a3dcd6cc23bc5c229ec648b35012c9533">TCPClient::loginError</a></div><div class="ttdeci">void loginError(const QString &amp;reason)</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00279">moc_tcpclient.cpp:279</a></div></div>
<div class="ttc" id="classTCPClient_html_a8d2ac91529f9dd88818b7b1ca265d975"><div class="ttname"><a href="classTCPClient.html#a8d2ac91529f9dd88818b7b1ca265d975">TCPClient::error</a></div><div class="ttdeci">void error(QAbstractSocket::SocketError socketError)</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00299">moc_tcpclient.cpp:299</a></div></div>
<div class="ttc" id="classTCPClient_html_aa9b17560c0541f8e6d6a827d93802e3f"><div class="ttname"><a href="classTCPClient.html#aa9b17560c0541f8e6d6a827d93802e3f">TCPClient::sendMessage</a></div><div class="ttdeci">void sendMessage(const QString &amp;text)</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00042">tcpclient.cpp:42</a></div></div>
<div class="ttc" id="classTCPClient_html_af039e584125912715c7eb7b095e168d7"><div class="ttname"><a href="classTCPClient.html#af039e584125912715c7eb7b095e168d7">TCPClient::sendTrackingDetails</a></div><div class="ttdeci">void sendTrackingDetails(QJsonObject &amp;text, QString satDataType, bool mode=true)</div><div class="ttdef"><b>Definition:</b> <a href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp_source.html#l00058">tcpclient.cpp:58</a></div></div>
<div class="ttc" id="classTCPClient_html_ac23819654a04521dda35667345b31ab0"><div class="ttname"><a href="classTCPClient.html#ac23819654a04521dda35667345b31ab0">TCPClient::userLeft</a></div><div class="ttdeci">void userLeft(const QString &amp;username)</div><div class="ttdef"><b>Definition:</b> <a href="Build_2GUI-Main_2moc__tcpclient_8cpp_source.html#l00313">moc_tcpclient.cpp:313</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_d2255ac8582c29822d3ace2d03a756b9.html">RotorDriver-GUI</a></li><li class="navelem"><a class="el" href="dir_d068a5e39a9da4a75709d56fb9b47b76.html">RotorDriver</a></li><li class="navelem"><a class="el" href="dir_5cad75f01a168e2a0ee75a559fe4d543.html">src</a></li><li class="navelem"><a class="el" href="RotorDriver-GUI_2RotorDriver_2src_2tcpclient_8cpp.html">tcpclient.cpp</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
